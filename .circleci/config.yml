# Use the latest 2.1 version of CircleCI pipeline process engine. See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1
# Use a package of configuration called an orb.

stage:
  -build

format-check:
  stage: build
  script:
    - MERGE_REQUEST_BASE=$(git merge-base origin/${CI_MERGE_REQUEST_SOURCE_BRANCH_NAME} origin/${CI_MERGE_REQUEST_TARGET_BRANCH_NAME})
    - git clang-format $MERGE_REQUEST_BASE
    - git diff --exit-code
  only:
    changes:
      - "**/*.{cpp,c,cc,h,hh,hpp,tpp,ino}"
    refs:
        - merge_requests
        
.files-triggering-build:
  only:
    changes:
      - "**/*.{cpp,c,cc,fbs,h,hh,hpp,tpp,ino}"

build:
  extends: .files-triggering-build
  stage: build
  artifacts:
    expire_in: 2 days



jobs:
  test:
    docker:
      - image: cimg/node:<node-version>
        auth:
          username: mydockerhub-user
          password: $DOCKERHUB_PASSWORD  # context / project UI env-var reference
    steps:
      - checkout
      - run:
          name: Format Check
          command: git clang-format $MERGE_REQUEST_BASE
      - run:
          name: Show Diff
          command: git diff --exit-code

workflows:
  test_my_app:
    jobs:
      - test
